import { getSession, signIn, signOut, useSession } from 'next-auth/react'\nimport { useEffect, useState } from 'react'\n\nfunction useDarkMode() {\n  const [enabled, setEnabled] = useState(false)\n  useEffect(() => {\n    const saved = localStorage.getItem('dark') === 'true'\n    setEnabled(saved)\n    document.documentElement.classList.toggle('dark', saved)\n  }, [])\n  useEffect(() => {\n    document.documentElement.classList.toggle('dark', enabled)\n    localStorage.setItem('dark', enabled)\n  }, [enabled])\n  return [enabled, setEnabled]\n}\n\nexport default function Home() {\n  const { data: session, status } = useSession()\n  const [enabled, setEnabled] = useDarkMode()\n\n  if (status === 'loading') return <div className=\"p-8\">Loading...</div>\n\n  if (!session) {\n    return (\n      <main className=\"container mx-auto p-8 flex flex-col items-center gap-6\">\n        <h1 className=\"text-3xl font-bold\">Outlook Complaint Summarizer</h1>\n        <p>Sign in with Microsoft to view daily summaries.</p>\n        <button onClick={() => signIn('azure-ad')} className=\"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700\">Sign in with Microsoft</button>\n      </main>\n    )\n  }\n\n  return <Dashboard />\n}\n\nfunction Dashboard() {\n  const [date, setDate] = useState(() => new Date().toISOString().slice(0,10))\n  const [page, setPage] = useState(1)\n  const [pageSize] = useState(10)\n  const [data, setData] = useState({ items: [], total: 0 })\n  const [loading, setLoading] = useState(false)\n\n  useEffect(() => {\n    const controller = new AbortController()\n    async function load() {\n      setLoading(true)\n      try {\n        const res = await fetch(`/api/summaries?date=${date}&page=${page}&pageSize=${pageSize}`, { signal: controller.signal })\n        const json = await res.json()\n        setData(json)\n      } catch (e) {\n        if (e.name !== 'AbortError') console.error(e)\n      } finally { setLoading(false) }\n    }\n    load()\n    return () => controller.abort()\n  }, [date, page, pageSize])\n\n  return (\n    <main className=\"container mx-auto p-4 md:p-8\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <h1 className=\"text-2xl font-bold\">Daily Summary</h1>\n        <div className=\"flex items-center gap-3\">\n          <input className=\"px-3 py-2 rounded border bg-white/70 dark:bg-black/30\" type=\"date\" value={date} onChange={e=>{setPage(1);setDate(e.target.value)}} />\n          <button onClick={()=>setEnabled(v=>!v)} className=\"px-3 py-2 rounded border\">{document.documentElement.classList.contains('dark') ? 'Light' : 'Dark'}</button>\n          <button onClick={()=>signOut()} className=\"px-3 py-2 rounded bg-red-600 text-white\">Sign out</button>\n        </div>\n      </div>\n\n      <div className=\"card p-4\">\n        {loading ? <div>Loading...</div> : <Table data={data.items} />}\n        <div className=\"mt-4 flex justify-between items-center\">\n          <div>Total: {data.total}</div>\n          <div className=\"flex items-center gap-2\">\n            <button disabled={page<=1} onClick={()=>setPage(p=>p-1)} className=\"px-3 py-1 rounded border disabled:opacity-50\">Prev</button>\n            <span>Page {page} / {Math.max(1, Math.ceil(data.total / pageSize))}</span>\n            <button disabled={(page*pageSize)>=data.total} onClick={()=>setPage(p=>p+1)} className=\"px-3 py-1 rounded border disabled:opacity-50\">Next</button>\n          </div>\n        </div>\n      </div>\n    </main>\n  )\n}\n\nfunction Badge({ status }) {\n  const color = status === 'Resolved' ? 'bg-green-600' : status === 'Unresolved' ? 'bg-yellow-600' : 'bg-gray-600'\n  return <span className={`px-2 py-1 rounded text-white ${color}`}>{status}</span>\n}\n\nfunction Table({ data }) {\n  return (\n    <div className=\"overflow-x-auto\">\n      <table className=\"min-w-full\">\n        <thead>\n          <tr className=\"text-left\">\n            <th className=\"p-2\">Client Name</th>\n            <th className=\"p-2\">Problem Mentioned</th>\n            <th className=\"p-2\">Solution Provided</th>\n            <th className=\"p-2\">Status</th>\n          </tr>\n        </thead>\n        <tbody>\n          {data.map((item)=> (\n            <tr key={item.messageId} className=\"border-t border-white/20\">\n              <td className=\"p-2\">{item.clientName || '-'}</td>\n              <td className=\"p-2 max-w-md whitespace-pre-wrap\">{item.problem || '-'}</td>\n              <td className=\"p-2 max-w-md whitespace-pre-wrap\">{item.solution || '-'}</td>\n              <td className=\"p-2\"><Badge status={item.status || 'Unknown'} /></td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  )\n}\n\nexport async function getServerSideProps(context) {\n  const session = await getSession(context)\n  if (!session) {\n    return { redirect: { destination: '/api/auth/signin', permanent: false } }\n  }\n  return { props: { } }\n}\n